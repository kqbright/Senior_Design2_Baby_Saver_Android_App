package com.babycartest;

import java.io.IOException;
import java.util.ArrayList;
import java.util.UUID;

import android.app.Activity;
import android.bluetooth.BluetoothAdapter;
import android.bluetooth.BluetoothDevice;
import android.bluetooth.BluetoothSocket;
import android.content.Intent;
import android.os.Bundle;
import android.view.View;
import android.widget.AdapterView;
import android.widget.AdapterView.OnItemClickListener;
import android.widget.ArrayAdapter;
import android.widget.ListView;
import android.widget.Toast;

public class ListViewBluetooth extends Activity {
	ListView listView ;
    
	public static final UUID MY_UUID = UUID.fromString("00001101-0000-1000-8000-00805F9B34FB");
	public static BluetoothSocket btSocket = null;
	
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.list_view_layout);
            
        @SuppressWarnings("unchecked")
		ArrayList <String> list = (ArrayList<String>) getIntent().getSerializableExtra(MainActivity.EXTRA_MESSAGE);
        
        // Get ListView object from xml
        listView = (ListView) findViewById(R.id.list);
        
        // Define a new Adapter
        // First parameter - Context
        // Second parameter - Layout for the row
        // Third parameter - ID of the TextView to which the data is written
        // Forth - the Array of data

        ArrayAdapter<String> adapter = new ArrayAdapter<String>(this,
          android.R.layout.simple_list_item_1, android.R.id.text1, list);

        // Assign adapter to ListView
        listView.setAdapter(adapter); 
        
        // ListView Item Click Listener
        listView.setOnItemClickListener(new OnItemClickListener() {

              @Override
              public void onItemClick(AdapterView<?> parent, View view,
                 int position, long id) {
                
               // ListView Clicked item index
               int itemPosition     = position;
               
               // ListView Clicked item value
               String  itemValue    = (String) listView.getItemAtPosition(position);
                  
                // Show Alert 
//                Toast.makeText(getApplicationContext(),
//                  "Position :"+itemPosition+"  ListItem : " +itemValue , Toast.LENGTH_LONG)
//                  .show();
                
                //connect here
                Connect();
              }

         }); 
    }
    
    
    
    public void Connect(String MAC) {
    	
    	//String MAC = "00:13:12:23:42:18";
    	BluetoothAdapter mBluetoothAdapter = BluetoothAdapter.getDefaultAdapter();
		BluetoothDevice device = mBluetoothAdapter.getRemoteDevice(MAC);
		Toast.makeText(getApplicationContext(), "Connecting...", Toast.LENGTH_LONG).show();
		mBluetoothAdapter.cancelDiscovery();
		try {
            btSocket = device.createRfcommSocketToServiceRecord(MY_UUID);
/* Here is the part the connection is made, by asking the device to create a
 *  RfcommSocket (Unsecure socket I guess), It map a port for us or something 
 *  like that */
                        
			btSocket.connect();
			Toast.makeText(getApplicationContext(), "Connected", Toast.LENGTH_LONG).show();
		} catch (IOException e) {
			try {
				btSocket.close();
			} catch (IOException e2) {
				Toast.makeText(getApplicationContext(), "Unable to end the connection", Toast.LENGTH_LONG).show();
			}
			Toast.makeText(getApplicationContext(), "Socket creation failed", Toast.LENGTH_LONG).show();
		}
		
		//beginListenForData();
               /* this is a method used to read what the Arduino says for example when you write Serial.print("Hello world.") in your Arduino code */
	}
    
    
    
    
    
    
    
    
}
